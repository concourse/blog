<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Running Docker in Concourse | Concourse Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Running Docker in Concourse" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So you want to run Docker in Concourse? Well this is the guide for you!" />
<meta property="og:description" content="So you want to run Docker in Concourse? Well this is the guide for you!" />
<link rel="canonical" href="http://localhost:4000/2020/12/29/running-docker-in-concourse.html" />
<meta property="og:url" content="http://localhost:4000/2020/12/29/running-docker-in-concourse.html" />
<meta property="og:site_name" content="Concourse Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-29T21:44:49-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Running Docker in Concourse" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-12-29T21:44:49-05:00","datePublished":"2020-12-29T21:44:49-05:00","description":"So you want to run Docker in Concourse? Well this is the guide for you!","headline":"Running Docker in Concourse","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/12/29/running-docker-in-concourse.html"},"url":"http://localhost:4000/2020/12/29/running-docker-in-concourse.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Concourse Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Concourse Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Running Docker in Concourse</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-12-29T21:44:49-05:00" itemprop="datePublished">Dec 29, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>So you want to run Docker in Concourse? Well this is the guide for you!</p>

<p>Let’ clarify what it is we want to do. <strong>We want to be able to run <code class="language-plaintext highlighter-rouge">docker-compose</code> inside a task in Concourse to bring up our application along side some other services (i.e. Redis, Postgres, MySQL, etc.).</strong></p>

<p>Thankfully this challenge has been solved by the community! There are a few “Docker-in-Docker” images designed to run in Concourse that are maintained by the community. Here’s a short list made from a cursory search, in no particular order:</p>

<ul>
  <li><a href="https://github.com/meAmidos/dcind">github.com/meAmidos/dcind</a></li>
  <li><a href="https://github.com/karlkfi/concourse-dcind">github.com/karlkfi/concourse-dcind</a></li>
  <li><a href="https://github.com/fhivemind/concourse-dind">github.com/fhivemind/concourse-dind</a></li>
  <li><a href="https://github.com/taylorsilva/dcind">github.com/taylorsilva/dcind</a></li>
</ul>

<p>You can also opt to build your own fork of the above images.</p>

<p>All of the above repositories have their own example pipelines that you can use to get started. What follows are some bits of information that are useful to know when using these task images.</p>

<h2 id="privileged-tasks">Privileged Tasks</h2>

<p>Running Docker inside Concourse requires the <a href="https://concourse-ci.org/jobs.html#schema.step.task-step.task">task step</a> to be <a href="https://concourse-ci.org/jobs.html#schema.step.task-step.privileged">privileged</a> because Docker needs access to the hosts cgroup filesystem in order to create containers.</p>

<p>You can verify this by looking at the bash scripts for each of the above images which all take inspiration from the <a href="https://github.com/concourse/docker-image-resource">docker-image resource</a>. Read the <a href="https://github.com/concourse/docker-image-resource/blob/babf5a7dc293102e34bd2bf93815ee3d35aac54e/assets/common.sh#L5-L48"><code class="language-plaintext highlighter-rouge">sanitize_cgroups</code> function</a> to see what exactly is being mounted from the host. (tldr: mount all cgroups as read-write)</p>

<h2 id="externalize-all-images">Externalize All Images</h2>

<p>You should avoid having Docker fetch any images from inside your task step where you are running <code class="language-plaintext highlighter-rouge">docker-compose</code>. You should externalize these as <a href="https://github.com/concourse/registry-image-resource">image resources</a> if they’re a dependency of your application (e.g. Postgres, MySQL).</p>

<p>For the container image that contains your application you should have that built in a previous <a href="https://concourse-ci.org/jobs.html#schema.step">step</a> or <a href="https://concourse-ci.org/pipelines.html#schema.pipeline.jobs">job</a>. You can <a href="__GHOST_URL__ /how-to-build-and-publish-a-container-image/">build and publish an image</a> using the <a href="https://github.com/vito/oci-build-task">oci-build task</a>.</p>

<p>To ensure Docker doesn’t try to fetch the images itself you can use <a href="https://docs.docker.com/engine/reference/commandline/load/"><code class="language-plaintext highlighter-rouge">docker load</code></a> and <a href="https://docs.docker.com/engine/reference/commandline/tag/"><code class="language-plaintext highlighter-rouge">docker tag</code></a> to load your externalized images into Docker. <a href="https://github.com/meAmidos">meAmidos’s</a> has a great <a href="https://github.com/meAmidos/dcind/blob/master/example/pipe.yml">example pipeline</a> that does exactly that.</p>

<p>meAmidos also makes two great points about why you should externalize your image:</p>

<ul>
  <li>If the image comes from a private repository, it is much easier to let Concourse pull it, and then pass it through to the task.</li>
  <li>When the image is passed to the task, Concourse can often get the image from its cache.</li>
</ul>

<p>That’s all you need to know to run Docker inside Concourse!</p>


  </div><a class="u-url" href="/2020/12/29/running-docker-in-concourse.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Concourse Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Concourse Blog</li><li><a class="u-email" href="mailto:noreply@blog.concourse-ci.org">noreply@blog.concourse-ci.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/concourse"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">concourse</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Come Fly The Friendly CI</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
